<!DOCTYPE HTML>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head th:include="include :: header"></head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <div class="form-group-separator" style="height: 1px;background: #eee;margin-bottom: 15px;"></div>
    <form class="form-horizontal edit-form" role="form" id="form-bankFileReceive-edit" th:object="${bankReceiveFiles}">
        <input type="hidden" id="accountId" name="id" th:field="*{id}">
        <input type="hidden" id="deptId" name="deptId" class="form-control" th:field="*{deptId}">
        <fieldset>
            <legend>基本信息</legend>
            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">登记号：</label>
                        <div class="col-sm-8">
                            <input id="registrationNum" name="registrationNum"  class="form-control" type="number" th:field="*{registrationNum}" readonly="readonly"/>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">文件密级：</label>
                        <div class="col-sm-8">
                            <select id="secretLevel" name="secretLevel" th:with="type=${@dict.getType('secrecy_level')}" th:field="*{secretLevel}">
                                <option th:each="dict: ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">紧急程度：</label>
                        <div class="col-sm-8">
                            <select id="urgency" name="urgency" th:with="type=${@dict.getType('urgency')}" th:field="*{urgency}">
                                <option th:each="dict: ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">份数：</label>
                        <div class="col-sm-8">
                            <input id="numOfCopies" name="numOfCopies" class="form-control" type="number" th:field="*{numOfCopies}" readonly="readonly">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">文号：</label>
                        <div class="col-sm-8">
                            <input id="documentNum" name="documentNum" class="form-control" type="text" th:field="*{documentNum}">
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">成文日期：</label>
                        <div class="col-sm-8">
                            <input id="handleTime" name="handleTime" class="form-control handleTime" type="text" th:field="*{handleTime}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="width: 12.666667%;">标题：</label>
                        <div class="col-sm-10">
                            <input id="title" name="title" class="form-control" type="text" th:field="*{title}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">发文单位：</label>
                        <div class="col-sm-8">
                            <input id="communicationUnit" name="communicationUnit" class="form-control" type="text"
                                   th:field="*{communicationUnit}">
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">联合单位：</label>
                        <div class="col-sm-8">
                            <input id="jointUnit" name="jointUnit" class="form-control" type="text" th:field="*{jointUnit}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">部门：</label>
                        <div class="col-sm-8">
                            <input id="deptName" name="deptName" class="form-control" type="text" th:field="*{deptName}" onclick="$('#tree').show()" tabindex="2" onfocus="this.blur();">
                            <div id="tree" style="display: none;position: absolute;z-index: 1010;background-color: white;margin-left: 0px;width: 95%;;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">联系人：</label>
                        <div class="col-sm-8">
                            <input id="contact" name="contact" class="form-control" type="text" th:field="*{contact}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">联系电话：</label>
                        <div class="col-sm-8">
                            <input id="phone" name="phone" class="form-control" type="text" th:field="*{phone}">
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">

                </div>
            </div>

        </fieldset>

        <div class="form-group-separator" style="height: 1px;background: #eee;margin-bottom: 15px;"></div>


    </form>
    <form lass="form-horizontal edit-form" role="form">
        <fieldset>
            <legend>审批意见</legend>
            <div class="row">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="width: 12.666667%;">行领导批示意见：</label>
                        <div class="col-sm-10 select-table table-bordered">
                            <table id="bootstrap-table" class="table table-bordered table-hover" data-mobile-responsive="true"></table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 15px">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="width: 12.666667%;">办公室主任意见：</label>
                        <div class="col-sm-10">
                            <input type="hidden" id="directorOpinionId" name="directorOpinionId" th:value="${directorOpinion?.id}">
                            <textarea id="directorOpinion" name="directorOpinion" class="form-control" type="text" style="height: 100px" th:text="${directorOpinion?.opinion}"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 15px">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="width: 12.666667%;">承办部门办理情况：</label>
                        <div class="col-sm-10" >
                            <input type="hidden" id="hostOpinionId" name="hostOpinionId" th:value="${hostOpinion?.id}">
                            <textarea id="hostOpinion" name="hostOpinion" class="form-control" type="text" style="height: 100px" th:text="${hostOpinion?.opinion}"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="width: 12.666667%;">协办部门办理情况：</label>
                        <div class="col-sm-10" >
                            <input type="hidden" id="coOrganzierOpinionId" name="coOrganzierOpinionId" th:value="${coOrganzierOpinion?.id}">
                            <label for="coOrganzierOpinion"></label><textarea id="coOrganzierOpinion" name="coOrganzierOpinion" class="form-control" type="text" style="height: 100px" th:text="${coOrganzierOpinion?.opinion}"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 50px;">
                <div class="col-xs-12">
                    <div class="control-group">
                        <div class="controls" style="text-align: center">
                            <button type="button" class="btn btn-primary" id="save">保存</button>
                            <button type="button" class="btn btn-primary" id="clear">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>

    </form>
</div>

<div th:include="include::footer"></div>
<script th:src="@{/bank/bootstrap-treeview.js}"></script>
<script th:src="@{/js/template.js}"></script>
<script th:inline="javascript">
    var prefix = ctx + "bank/receive";
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        lay('.handleTime').each(function(){
            laydate.render({
                elem: this
                ,trigger: 'click'
                ,type: 'date'
            });
        });
    });

    (function ($) {
        $.fn.serializeJson = function () {
            var serializeObj = {};
            var array = this.serializeArray();
            var str = this.serialize();
            $(array).each(function () {
                if (serializeObj[this.name]) {
                    if ($.isArray(serializeObj[this.name])) {
                        serializeObj[this.name].push(this.value);
                    } else {
                        serializeObj[this.name] = [serializeObj[this.name], this.value];
                    }
                } else {
                    serializeObj[this.name] = this.value;
                }
            });
            return serializeObj;
        }
    })(jQuery);

    $(function () {
        var url = ctx + 'system/dept/getSysDeptTree/';
        var config = {
            url: url,
            type: 'get',
            contentType: 'application/json',
            async: false,
            success: function (result) {
                if (result != null) {
                    var options = {
                        levels: 1,
                        data: result,
                        onNodeSelected: function (event, data) {
                            $('#deptName').val(data.text);
                            $('#deptId').val(data.href);
                            $('#tree').hide();//选中树节点后隐藏
                        }
                    };
                    $('#tree').treeview(options);
                }
            }, error: function () {
                layer.msg("下拉部门加载失败");
            }
        };
        $.ajax(config);

        var fileId = [[${fileId}]] || '';
        var registrationNum = [[${registrationNum}]] || '';

        var options = {
            url: ctx + "bank/sign/list?registrationNum=" + registrationNum,
            createUrl: ctx + "bank/sign//add",
            removeUrl: ctx + "bank/sign//remove",
            sortName: "createTime",
            sortOrder: "desc",
            uniqueId: "id",
            search: false,
            showExport: false,
            showToggle: false,
            showSearch: false,
            showColumns: false,
            showRefresh: false,
            pagination: false,
            modalName: '文件签署意见',
            editable: true,
            columns: [
                {
                    field: 'id',
                    title: 'ID',
                    visible: false,
                    align: 'center'
                },
                {
                    field: 'opinion',
                    title: '意见及情况',
                    align: 'center',
                    /*editable: {
                        type: 'text'
                    },
                    formatter: function (value, row, index) {
                        return "<input type='text' name='opinion' value='" + value + "' onblur='changeData("+ index +", this)' style='width: 100%;height: 30px;'/>";
                    }*/
                },
                {
                    title: '操作',
                    align: 'center',
                    visible: false,
                    formatter: function (value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-danger btn-xs " href="#" onclick="remove(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a>');
                        return actions.join('');
                    }
                }]
        };
        $.table.init(options);
    });

    function remove(id) {
        $.modal.confirm("确定删除该条文件签署意见信息吗？", function() {
            var url =  ctx + "bank/sign//remove";
            var data = { "ids": id };
            $.modal.loading("正在处理中，请稍后...");
            var config = {
                url: url,
                type: "post",
                dataType: "json",
                data: data,
                success: function(result) {
                    if (result.code == web_status.SUCCESS) {
                        $.modal.msgSuccess(result.msg);
                        $.table.refresh();
                    } else {
                        $.modal.alertError(result.msg);
                    }
                    $.modal.closeLoading();
                }
            };
            $.ajax(config)
        });
    }

    var $bootstrap = $("#bootstrap-table");

    /**
     * 编辑行
     * @param index
     * @param obj
     */
    function changeData(index, obj) {
        var value = $(obj).val();
        var name = $(obj).attr('name');

        var row = $bootstrap.bootstrapTable('getOptions').data[index];
        row[name] = value;
        $bootstrap.bootstrapTable('updateRow', {
            index: index,
            row: row
        });
    }

    $("#form-bankFileReceive-edit").validate({
        rules: {
            registrationNum: {
                required: true,
                minlength: 9,
                maxlength: 9,
                remote: {
                    url: prefix + "/checkRegistrationNumUnique",
                    type: "post",
                    dataType: "json",
                    data: {
                        "registrationNum" : function() {
                            return $.common.trim($("#registrationNum").val());
                        },
                        "id": function() {
                            return $("#accountId").val();
                        },
                    },
                    dataFilter: function(data, type) {
                        return $.validate.unique(data);
                    }
                }
            },
            secretLevel: {
                required: true
            },
            urgency:{
                required: true
            },
            numOfCopies: {
                required: true,
                min: 0
            },
            documentNum: {
                required: true
            },
            handleTime: {
                required: true
            },
            title: {
                required: true
            },
            communicationUnit: {
                required: true
            },
            deptName: {
                required: true
            }
        },
        messages: {
            "registrationNum": {
                remote: "登记号已经存在"
            }
        }
    });

    $('#clear').on('click', function () {
        var s = [[${fileId}]];
        var dataUrl = ctx + 'bank/receive/edit/' + s;
        $.modal.closeTab(dataUrl);

    });

    $('#save').on('click', function () {
        submitHandler();
    });

    function clearHandler() {
        console.log("清空操作");
        $(":input", '#form-bankFileReceive-add')
            .not(':button, :submit, :reset, :hidden')
            .val('')
            .removeAttr('checked')
            .removeAttr('selected');
    }

    function createFileSignOpinion() {
        var allTableData = $bootstrap.bootstrapTable('getData');
        console.log(allTableData);
        var objArr = [];
        $.each(allTableData, function (i, e) {
           var fileSignOpinion = new Object();
            fileSignOpinion.id = e.id;
            fileSignOpinion.opinion = e.opinion;
            objArr.push(fileSignOpinion);
        });
        return objArr;
    }

    function submitHandler() {
        if ($.validate.form()) {
            var fileSignOpinion = createFileSignOpinion();
            console.log(fileSignOpinion);
            var url = prefix + "/edit";
            var resultBean = {};
            resultBean.bankReceiveFiles = $('#form-bankFileReceive-edit').serializeJson();
            resultBean.bankFileSignOpinions = fileSignOpinion;
            resultBean.directorOpinionId = $('#directorOpinionId').val();
            resultBean.hostOpinionId = $('#hostOpinionId').val();
            resultBean.coOrganzierOpinionId = $('#coOrganzierOpinionId').val();
            resultBean.directorOpinion = $('#directorOpinion').val();
            resultBean.hostOpinion = $('#hostOpinion').val();
            resultBean.coOrganzierOpinion = $('#coOrganzierOpinion').val();
            $.modal.loading("正在处理中，请稍后...");
            var config = {
                url: url,
                type: "post",
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(resultBean),
                success: function(result) {
                    if (result.code == 0) {
                        layer.msg("保存成功,正在刷新数据请稍后……", { icon: 1, time: 2000, shift: 5,shade: [0.1, '#8F8F8F'] }, function () {
                            createMenuItem(ctx + 'bank/receive', "文件台账");
                            $.modal.closeTab(prefix + "/edit/" + [[${fileId}]]);
                        });
                    } else {
                        $.modal.alertError(result.msg);
                    }
                    $.modal.closeLoading();
                }
            };
            $.ajax(config);
        }
    }
</script>
</body>
</html>
